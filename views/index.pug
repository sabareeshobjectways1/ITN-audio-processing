doctype html
head
  meta(name='viewport' content='width=device-width,initial-scale=1')
  title ITN Tool
  script(src='https://code.jquery.com/jquery-3.4.1.min.js' integrity='sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=' crossorigin='anonymous')
  link(rel='stylesheet' href='https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css')
  link(rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css')
  link(rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css' integrity='sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh' crossorigin='anonymous')
  script(src='https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js' integrity='sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo' crossorigin='anonymous')
  script(src='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js' integrity='sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6' crossorigin='anonymous')
  script(src='/mainFunction/audiodisplay.js')
  script(src='/mainFunction/recorderjs/recorder.js')
  script(src='/mainFunction/medical-recorder-enhanced.js')
  style.
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      padding-top: 20px;
    }
    .recording-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-bottom: 20px;
    }
    .waveform-container {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    canvas {
      background: #ffffff;
      width: 100%;
      height: 120px;
      border-radius: 5px;
      border: 1px solid #dee2e6;
    }
    .audio-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
    }
    .control-btn {
      min-width: 140px;
      height: 50px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      cursor: pointer;
    }
    .control-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    .control-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .record-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    .record-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #218838, #1ba085);
    }
    .record-btn.recording {
      background: linear-gradient(135deg, #dc3545, #c82333);
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
    .pause-btn {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: #212529;
    }
    .pause-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #e0a800, #d39e00);
    }
    .stop-btn {
      background: linear-gradient(135deg, #6c757d, #5a6268);
      color: white;
    }
    .stop-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a6268, #495057);
    }
    .listen-btn {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
    }
    .listen-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #138496, #117a8b);
    }
    .submit-btn {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }
    .submit-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #0056b3, #004085);
    }
    .submit-btn.loading {
      background: linear-gradient(135deg, #6c757d, #5a6268);
      cursor: not-allowed;
      position: relative;
    }
    .submit-btn.loading i {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .rerecord-btn {
      background: linear-gradient(135deg, #fd7e14, #e8690b);
      color: white;
    }
    .rerecord-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #e8690b, #d35400);
    }
    .confirm-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
      max-width: 250px;
      margin: 0 auto;
    }
    .confirm-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #218838, #1ba085);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.16);
    }
    .btn-warning.confirm-btn {
      background: linear-gradient(135deg, #fd7e14, #e8690b);
    }
    .btn-warning.confirm-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #e8690b, #d35400);
    }
    @keyframes pulse {
      from {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
      }
      to {
        box-shadow: 0 0 0 20px rgba(220, 53, 69, 0);
      }
    }
    .timer-display {
      font-size: 24px;
      font-weight: bold;
      color: #495057;
      text-align: center;
      margin: 10px 0;
    }
    .form-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 25px;
    }
    .content-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 25px;
      border-left: 4px solid #007bff;
    }
    .content-header h5 {
      color: #007bff;
      font-weight: 600;
      margin-bottom: 15px;
    }
    .content-text {
      font-size: 20px;
      font-weight: 700;
      line-height: 1.6;
      color: #212529;
      background: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      margin-top: 10px;
      text-align: center;
      letter-spacing: 0.3px;
    }
    .content-placeholder {
      text-align: center;
      color: #6c757d;
      padding: 30px;
    }
    .placeholder-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .language-loader {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      text-align: center;
    }
    .loader-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .spinner {
      margin-bottom: 10px;
    }
    .language-info {
      margin-top: 5px;
    }
    .category-badge-container {
      display: flex;
      justify-content: center;
    }
    .category-badge {
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 15px;
    }
    .sentence-display {
      font-size: 20px;
      font-weight: 700;
      line-height: 1.6;
      color: #212529;
      margin-bottom: 15px;
    }
      font-style: italic;
      padding: 40px 20px;
    }
    .completion-screen {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #e8f5e8, #f0fff0);
      border-radius: 15px;
      border: 2px solid #28a745;
    }
    .completion-screen i {
      animation: checkmark 0.6s ease-in-out;
    }
    @keyframes checkmark {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .hidden {
      display: none !important;
    }
    .disabled-section {
      opacity: 0.6;
      pointer-events: none;
    }
    .disabled-section .control-btn {
      cursor: not-allowed;
      opacity: 0.5;
    }
    #ageGroup {
      background-color: #f8f9fa !important;
      color: #6c757d !important;
      cursor: not-allowed !important;
      pointer-events: none;
      border-color: #e9ecef !important;
    }
    .wer-display {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
    }
    .wer-good {
      border-color: #28a745;
      background: #d4edda;
      color: #155724;
    }
    .wer-bad {
      border-color: #dc3545;
      background: #f8d7da;
      color: #721c24;
    }
    .transcription-display {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 14px;
    }
    .upload-mode-section {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .file-upload-area {
      border: 2px dashed #007bff;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin: 15px 0;
      background: #f8f9fa;
    }
    .file-upload-area.dragover {
      border-color: #28a745;
      background: #d4edda;
    }
    
    /* Audio Playback Section Styling */
    .audio-playback-section {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .audio-player-container {
      margin-bottom: 15px;
    }
    
    .seek-controls {
      margin: 15px 0;
    }
    
    .seek-controls-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .seek-btn {
      background: linear-gradient(135deg, #6c757d, #5a6268);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      min-width: 60px;
    }
    
    .seek-btn:hover {
      background: linear-gradient(135deg, #5a6268, #495057);
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }
    
    .seek-btn i {
      margin-right: 3px;
    }
    
    /* Transcription Progress - Simple Text Display */
    .transcription-progress {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    
    .transcription-progress .fa-spinner {
      color: #007bff;
      margin-right: 10px;
    }
    
    /* ITN Tags Styling */
    .itn-tag {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      padding: 2px 6px;
      font-weight: bold;
      color: #856404;
      font-family: monospace;
      font-size: 12px;
    }
    
    .itn-content {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 4px;
      padding: 2px 4px;
      color: #0c5460;
      font-weight: bold;
    }
    
    // Responsive design for mobile and tablet
    @media (max-width: 768px) {
      .container-fluid {
        padding: 10px;
      }
      
      .col-md-4, .col-md-8 {
        margin-bottom: 20px;
      }
      
      .audio-controls {
        flex-direction: column;
        gap: 10px;
      }
      
      .control-btn {
        min-width: 120px;
        height: 45px;
        font-size: 14px;
      }
      
      .content-text {
        font-size: 16px;
        padding: 15px;
      }
      
      .waveform-container {
        padding: 15px;
      }
      
      canvas {
        height: 80px;
      }
      
      .form-section, .content-section, .recording-section {
        padding: 20px;
        margin-bottom: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .control-btn {
        min-width: 100px;
        height: 40px;
        font-size: 12px;
      }
      
      .content-text {
        font-size: 14px;
        padding: 10px;
      }
      
      .timer-display {
        font-size: 20px;
      }
      
      .form-section, .content-section, .recording-section {
        padding: 15px;
      }
    }
    
    /* Responsive Design - Mobile First */
    @media (max-width: 768px) {
      .container-fluid {
        padding: 5px;
      }
      
      .col-md-4 {
        margin-bottom: 15px;
        padding: 0 5px;
      }
      
      .audio-controls {
        flex-direction: column;
        gap: 8px;
      }
      
      .audio-controls .d-flex {
        flex-direction: column;
        gap: 8px;
      }
      
      .control-btn {
        min-width: 100%;
        height: 45px;
        font-size: 14px;
        margin: 0 !important;
      }
      
      .content-text {
        font-size: 16px;
        padding: 15px;
      }
      
      .waveform-container {
        padding: 10px;
      }
      
      canvas {
        height: 80px;
      }
      
      .form-section, .content-section, .recording-section {
        padding: 15px;
        margin-bottom: 10px;
      }
      
      .seek-controls-wrapper {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        gap: 5px;
      }
      
      .seek-btn {
        min-width: 45px;
        padding: 6px 10px;
        font-size: 11px;
      }
      
      .navigation-buttons {
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      
      .content-header {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      
      .header-arrows {
        order: 2;
      }
      
      .content-info {
        order: 3;
        text-align: center;
      }
      
      h5.text-center {
        order: 1;
        margin-bottom: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .container-fluid {
        padding: 2px;
      }
      
      .control-btn {
        height: 40px;
        font-size: 12px;
        min-width: 100%;
      }
      
      .content-text {
        font-size: 14px;
        padding: 10px;
      }
      
      .timer-display {
        font-size: 18px;
      }
      
      .form-section, .content-section, .recording-section {
        padding: 10px;
        margin-bottom: 8px;
      }
      
      .seek-btn {
        min-width: 40px;
        padding: 5px 8px;
        font-size: 10px;
      }
      
      .transcription-section {
        padding: 8px;
      }
      
      .original-text, .verbatim-text, .itn-text {
        font-size: 11px;
        padding: 5px;
      }
      
      .content-header h5 {
        font-size: 1rem;
      }
      
      .category-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
      }
      
      .form-group label {
        font-size: 0.9rem;
      }
      
      .form-control {
        font-size: 0.9rem;
      }
    }
    
    /* Transcription results styling */
    .transcription-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .original-text, .verbatim-text, .itn-text {
      background: #ffffff;
      border: 1px solid #e9ecef;
      border-radius: 3px;
      padding: 8px;
      margin: 5px 0;
      font-family: monospace;
      font-size: 13px;
    }
    
    .original-text {
      border-left: 4px solid #007bff;
    }
    
    .verbatim-text {
      border-left: 4px solid #28a745;
    }
    
    .itn-text {
      border-left: 4px solid #ffc107;
    }
    
    .uploaded-audio-info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .sentence-navigation {
      margin: 10px 0;
      text-align: center;
    }
    
    .current-sentence-info {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #495057;
    }
    
    .navigation-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    @media (max-width: 480px) {
      .navigation-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
    
    // Category badge styles
    .category-badge {
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.375rem 0.75rem;
      border-radius: 0.5rem;
    }
    .category-address { background-color: #28a745; color: white; }
    .category-num { background-color: #007bff; color: white; }
    .category-phone { background-color: #fd7e14; color: white; }
    .category-serial { background-color: #6f42c1; color: white; }
    .category-currency { background-color: #20c997; color: white; }
    .category-date { background-color: #e83e8c; color: white; }
    .category-time { background-color: #ffc107; color: black; }
    .category-unit { background-color: #6c757d; color: white; }
    .category-url { background-color: #17a2b8; color: white; }
    .category-misc { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }
    .category-other { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }
    
    .sentence-display {
      font-size: 1.25rem;
      font-weight: 500;
      line-height: 1.6;
      color: #212529;
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      text-align: center;
    }
    
    .content-info {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Language Loader Styles */
    .content-loader {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px solid #e9ecef;
    }
    
    .loader-container {
      text-align: center;
      padding: 2rem;
    }
    
    .loader-text h6 {
      margin-top: 1rem;
      color: #007bff;
      font-weight: 600;
    }
    
    .loader-text p {
      margin-bottom: 0;
      font-size: 0.9rem;
    }

    /* AI Category Analysis Styles */
    .category-analysis {
      background: #ffffff;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .category-badge-container {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .category-badge {
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .category-details {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 5px;
      font-style: italic;
    }
    
    .language-info {
      margin-top: 0.5rem;
      opacity: 0.8;
    }
    
    /* Bootstrap Badge Color Overrides for AI Categories */
    .badge-primary { background-color: #007bff !important; }
    .badge-success { background-color: #28a745 !important; }
    .badge-info { background-color: #17a2b8 !important; }
    .badge-warning { background-color: #ffc107 !important; color: #212529 !important; }
    .badge-secondary { background-color: #6c757d !important; }
    .badge-dark { background-color: #343a40 !important; }
    .badge-light { background-color: #f8f9fa !important; color: #495057 !important; border: 1px solid #dee2e6; }


body
  .container-fluid
    .row
      .col-md-4
        .form-section
          h4.mb-3 Speaker Information
          #speakerFormContainer
            form#speakerForm
              .form-group
                label(for='speakerId') Speaker ID *
                input#speakerId.form-control(type='text' required placeholder='Enter Speaker ID')
              .form-group
                label(for='speakerName') Name *
                input#speakerName.form-control(type='text' required placeholder='Enter Full Name')
              .form-group
                label(for='speakerGender') Gender *
                select#speakerGender.form-control(required)
                  option(value='') Select Gender
                  option(value='Male') Male
                  option(value='Female') Female
              .form-group
                label(for='speakerAge') Age *
                input#speakerAge.form-control(type='number' required min='18' max='100' placeholder='Enter Age')
              .form-group
                label(for='frequency') Recording Frequency *
                select#frequency.form-control(required)
                  option(value='') Select Frequency
                  option(value='8000') 8 kHz
                  option(value='16000') 16 kHz
              .form-group
                label(for='language') Language *
                select#language.form-control(required)
                  option(value='') Select Language
                  option(value='zh-HK') Cantonese (Hong Kong)
                  option(value='yue-CN') Cantonese (Mainland China)
                  option(value='id-ID') Indonesian
                  option(value='it-IT') Italian
                  option(value='pl-PL') Polish
                  option(value='pt-BR') Portuguese (Brazilian)
                  option(value='pt-PT') Portuguese (European)
                  option(value='es-ES') Spanish (European)
                  option(value='es-US') Spanish (USA)
                  option(value='th-TH') Thai
                  option(value='en-IN') English (Indian)
              .form-group
                label(for='languageCode') Language Code *
                input#languageCode.form-control(type='text' readonly placeholder='Auto-filled based on language selection')
              .form-group.mt-3.text-center
                button#confirmSpeakerBtn.btn.btn-success.confirm-btn(type='button')
                  i.fa.fa-check
                  |  Confirm Speaker Information


      .col-md-4.order-md-2
        // Right Panel: Only Audio Control Buttons
        .recording-section#recordingButtonsSection.disabled-section
          .audio-controls.flex-column
            .d-flex.justify-content-center.mb-2
              button#recordBtn.control-btn.record-btn(type='button')
                i.fa.fa-microphone
                |  Start Recording
              button#pauseBtn.control-btn.pause-btn(type='button' disabled style='margin-left:10px;')
                i.fa.fa-pause
                |  Pause
            .d-flex.justify-content-center
              button#listenBtn.control-btn.listen-btn(type='button' disabled)
                i.fa.fa-play
                |  Listen
              button#rerecordBtn.control-btn.rerecord-btn(type='button' disabled style='margin-left:10px;')
                i.fa.fa-refresh
                |  Re-record
              button#submitBtn.control-btn.submit-btn(type='button' disabled style='margin-left:10px;')
                i.fa.fa-upload
                |  Submit
          // Feedback Button
          .d-flex.justify-content-center.mt-3
            button#feedbackBtn.btn.btn-outline-info(type='button' disabled)
              i.fa.fa-commenting
              |  Feedback (Optional)
          // Feedback Form (hidden by default)
          form#feedbackForm.mt-3.hidden(style='background:#f8f9fa; border-radius:8px; border:1px solid #e9ecef; padding:16px;')
            div.form-group
              label(for='feedbackText') Your Feedback (Optional)
              small.text-muted Pre-filled with ITN content for your review and corrections
              textarea#feedbackText.form-control(rows='4' placeholder='ITN content will be automatically filled here for your review...')
            div.text-right
              button#cancelFeedbackBtn.btn.btn-secondary(type='button' style='margin-right:8px;') Cancel
      .col-md-4.order-md-1
        // Center Panel: Content Display Section
        .content-section#currentContent.mb-4
          .content-header.d-flex.justify-content-between.align-items-center
            // Arrow navigation at header
            .header-arrows.d-flex.align-items-center
              button.btn.btn-outline-primary.btn-sm#prevSentenceBtnHeader(type='button', aria-label='Previous', title='Previous')
                i.fa.fa-arrow-left
              button.btn.btn-outline-primary.btn-sm#nextSentenceBtnHeader.ml-2(type='button', aria-label='Next', title='Next')
                i.fa.fa-arrow-right
            h5.mb-0.flex-grow-1.text-center Content to Record
            .content-info#contentInfo.text-muted
              span#currentSentenceInfo (1/27)
              span.mx-2 
              
            
        
          .content-placeholder#contentPlaceholder
            p Please select a language to see the content immediately.
          .content-text.hidden#sentenceContent
            .sentence-display#sentenceText
              | Select a language to see content
        // Audio Display Section for uploaded files
        .content-section#uploadedAudioSection.hidden.mb-4
          .content-header
            h5 Uploaded Audio Content
          #uploadedAudioPlayer
          #uploadedAudioTranscription.transcription-display.hidden
        // WER Display Section
        #werDisplaySection.wer-display.hidden
          h6 Word Error Rate (WER) Analysis
          #werResult
          #transcriptionResult.transcription-display.hidden
        // Center: Waveform and Audio Playback
        .recording-section#recordingSection.disabled-section
          // File Upload Area (hidden by default)
          .file-upload-area#fileUploadArea.hidden
            i.fa.fa-cloud-upload(style='font-size: 48px; color: #007bff; margin-bottom: 15px;')
            h5 Upload WAV File
            p Drag and drop your WAV file here or click to browse
            input#audioFileInput(type='file' accept='.wav' style='display: none;')
            button#browseFileBtn.btn.btn-primary(type='button') Browse Files
          .waveform-container#waveformContainer
            canvas#waveformCanvas
            canvas#analyserCanvas.hidden
            .timer-display#timerDisplay 00:00:00
          // Audio playback controls (shown after recording)
          .audio-playback-section#audioPlaybackSection.hidden
            .audio-player-container
              audio#audioPlayback.audio-playback(controls style='width: 100%; margin: 10px 0;')
            .seek-controls#seekControls
              .seek-controls-wrapper
                button.seek-btn#seekBack5(type='button')
                  i.fa.fa-fast-backward
                  |  5s
                button.seek-btn#seekBack1(type='button')
                  i.fa.fa-step-backward
                  |  1s
                button.seek-btn#seekForward1(type='button')
                  |  1s
                  i.fa.fa-step-forward
                button.seek-btn#seekForward5(type='button')
                  |  5s
                  i.fa.fa-fast-forward

  script.
    // Initialize the enhanced medical recorder when page loads
    document.addEventListener('DOMContentLoaded', function() {
        window.medicalRecorder = new EnhancedMedicalRecorder();
        
        // Initialize feedback system
        initializeFeedbackSystem();
    });
    
    // Feedback system initialization
    function initializeFeedbackSystem() {
        var feedbackBtn = document.getElementById('feedbackBtn');
        var feedbackForm = document.getElementById('feedbackForm');
        var feedbackText = document.getElementById('feedbackText');
        var cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
        
    // Store current ITN content for feedback
    window.currentItnContent = '';

    // Make feedback input empty by default
    if (feedbackText) {
      feedbackText.value = '';
    }

    // Show feedback form when button is clicked
    if (feedbackBtn && feedbackForm) {
      feedbackBtn.addEventListener('click', function() {
        feedbackForm.classList.remove('hidden');
        feedbackBtn.classList.add('hidden');
      });
    }

    // Hide feedback form when cancel is clicked
    if (cancelFeedbackBtn && feedbackForm) {
      cancelFeedbackBtn.addEventListener('click', function(e) {
        e.preventDefault();
        feedbackForm.classList.add('hidden');
        feedbackBtn.classList.remove('hidden');
      });
    }

    // Enable feedback button and populate ITN content when transcription is complete
    window.enableFeedbackWithITN = function(itnContent) {
      if (feedbackText) {
        // Store ITN content
        window.currentItnContent = itnContent || '';
        // Only set placeholder, do not fill value
        feedbackText.placeholder = 'ITN content: ' + window.currentItnContent + '\nPlease review and make any necessary corrections above.';
        console.log('✅ Feedback placeholder prepared (button will be enabled when submit is enabled)');
      }
    };

    // Save feedback as JSON in S3/local when user fills it
    if (feedbackText) {
      feedbackText.addEventListener('change', function() {
        var feedbackValue = feedbackText.value.trim();
        if (feedbackValue) {
          var feedbackObj = {
            feedback: feedbackValue,
            timestamp: new Date().toISOString()
          };
          // Save to localStorage
          localStorage.setItem('medical_feedback', JSON.stringify(feedbackObj));
          // Send to backend for S3 storage
          fetch('/api/save-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(feedbackObj)
          }).then(r => r.json()).then(res => {
            console.log('Feedback saved to S3/local:', res);
          }).catch(err => {
            console.error('Error saving feedback:', err);
          });
        }
      });
    }
        
        // Clear feedback content
        window.clearFeedbackContent = function() {
            if (feedbackText) {
                feedbackText.value = '';
                window.currentItnContent = '';
            }
            if (feedbackBtn) {
                feedbackBtn.disabled = true;
            }
            if (feedbackForm && feedbackBtn) {
                feedbackForm.classList.add('hidden');
                feedbackBtn.classList.remove('hidden');
            }
            console.log('✅ Feedback content cleared');
        };
        
        // Get current feedback content
        window.getCurrentFeedback = function() {
            return feedbackText ? feedbackText.value.trim() : '';
        };
    }